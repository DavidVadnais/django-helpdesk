{% extends "helpdesk/public_base.html" %}{% load i18n %}

{% block helpdesk_body %}
<h2>{% trans "My Tickets" %}</h2>

<div class="container mt-4">
    <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" id="hideClosed">
        <label class="form-check-label" for="hideClosed">
            {% trans "Hide Closed Tickets" %}
        </label>
    </div>

    <table class="table table-striped" id="ticketsTable">
        <thead>
            <tr>
                <th>{% trans "Title" %}</th>
                <th>{% trans "Queue" %}</th>
                <th>{% trans "Status" %}</th>
                <th>{% trans "Created" %}</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be added here dynamically using jQuery -->
        </tbody>
    </table>
    <nav aria-label="{% trans 'Page navigation' %}">
        <ul class="pagination" id="pagination">
            <!-- Pagination buttons will be added here dynamically -->
        </ul>
    </nav>
</div>

<script>
window.addEventListener('load', function() {
    let currentSortColumn = null;
    let currentSortDirection = 'asc';

    function fetchTickets(page = 1) {
        const endpoint = '{% url "helpdesk:user_tickets-list" %}?page=' + page;

        $.get(endpoint, function(data) {
            let tickets = data.results.slice();

            if ($('#hideClosed').is(':checked')) {
                tickets = tickets.filter(ticket => ticket.status.toLowerCase() !== 'closed');
            }

            if (currentSortColumn) {
                tickets.sort((a, b) => {
                    let valA = a[currentSortColumn];
                    let valB = b[currentSortColumn];

                    if (currentSortColumn === 'queue') {
                        valA = a.queue.title;
                        valB = b.queue.title;
                    }
                    if (currentSortColumn === 'created') {
                        valA = new Date(valA);
                        valB = new Date(valB);
                    }

                    if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            $('#ticketsTable tbody').empty();
            tickets.forEach(function(ticket) {
                ticket.title = $('<div>').html(ticket.title).html();
                $('#ticketsTable tbody').append(`
                    <tr>
                        <td>
                            <a href='{% url "helpdesk:public_view" %}?ticket=${ticket.id}&email=${ticket.submitter}&key=${ticket.secret_key}'>${ticket.title}</a>
                        </td>
                        <td>${ticket.queue.title}</td>
                        <td>${ticket.status}</td>
                        <td>${ticket.created}</td>
                    </tr>
                `);
            });

            $('#pagination').on('click', 'a.page-link', function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                fetchTickets(page);
            });

            $('#hideClosed').change(function() {
                fetchTickets();
            });

            updateSortIcons();
        });
    }

    function updateSortIcons() {
        $('#ticketsTable thead th').each(function(index) {
            const columnMap = {
                0: 'title',
                1: 'queue',
                2: 'status',
                3: 'created'
            };
            const colName = columnMap[index];
            let text = $(this).data('label'); // keep original text
            let icon = '';

            if (colName === currentSortColumn) {
                icon = currentSortDirection === 'asc' ? ' ▲' : ' ▼';
            } else {
                icon = ' ↕'; // indicate sortable but inactive
            }

            $(this).html(text + icon);
        });
    }

    // Save original labels so we can reset them when adding icons
    $('#ticketsTable thead th').each(function() {
        $(this).data('label', $(this).text().trim());
    });

    $('#ticketsTable thead th').click(function() {
        const columnMap = {
            0: 'title',
            1: 'queue',
            2: 'status',
            3: 'created'
        };

        const colIndex = $(this).index();
        const colName = columnMap[colIndex];

        if (currentSortColumn === colName) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortColumn = colName;
            currentSortDirection = 'asc';
        }

        fetchTickets();
    });

    fetchTickets();
});
</script>

{% endblock %}
